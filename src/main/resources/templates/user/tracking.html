<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking -  TraceIT</title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.js"></script>
    <link rel="stylesheet"th:href="@{/css/scrollbar.css}">
    <link rel="shortcut icon" th:href="@{/img/vTSLogo.png}" type="image/x-icon">

    <style>
        /* Ensure the map takes the full width of the screen */
        #map {
            width: 100%;
            height: 100vh; /* Full viewport height */
        }

        /* Floatbox styling */
        #floatbox {
            position: fixed;
            top: 20px; /* Adjust if you want some spacing from the top */
            right: 0;
            width: 20rem; /* Set the width as needed */
            height: auto; /* Height adjusts based on content */
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            z-index: 40; /* Keep it above other content */
            overflow-y: auto; /* Add scroll if the content exceeds the screen height */
        }
    </style>
</head>
<body class=" font-sans leading-normal tracking-normal">
<div class="flex h-screen ">
    <!-- Sidebar with Scrollable Content -->
    <div class="mx-auto flex max-w-sm flex-col items-center gap-3 rounded-xl border border-gray-100 pt-8 text-gray-900 shadow-lg h-full">

        <!-- Fixed Navigation -->
        <div class="w-full px-2 space-x-2 flex justify-between bg-white py-2 sticky top-0 shadow-md z-10">
            <button id="unitsTab" class="flex items-center rounded-lg bg-blue-500 px-6 py-1 text-sm font-medium text-white outline-none transition focus:ring active:bg-blue-500 active:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Units
            </button>
            <button id="detailsTab" class="flex items-center rounded-lg px-4 py-1 text-sm font-medium text-gray-400 outline-none transition focus:ring active:bg-blue-500 active:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
                </svg>
                Details
            </button>
            <button id="moreTab" class="flex items-center rounded-lg px-4 py-1 text-sm font-medium text-gray-400 outline-none transition focus:ring active:bg-blue-500 active:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                More
            </button>
        </div>

        <!-- Scrollable Stacked Elements (Units List) -->
        <div id="unitsContainer" class="h-full w-full px-2 overflow-y-auto flex-1 scrollbar space-y-3"></div>

        <!-- Details Section -->
        <div id="detailsSection" class="hidden p-4 bg-white rounded-lg shadow-lg mt-4">
            <button onclick="goBack()" class="mb-2 px-4 py-2 bg-blue-500 text-white rounded">Back</button>
            <div id="detailsContent"></div>
        </div>

        <!-- More Section -->
        <div id="moreSection" class="hidden p-4 bg-white rounded-lg shadow-lg mt-4">
            <h3 class="text-lg font-semibold mb-2">More Options</h3>
            <button class="block w-full px-4 py-2 bg-gray-300 rounded mb-2">Manage Units</button>
            <button class="block w-full px-4 py-2 bg-gray-300 rounded">Settings</button>
        </div>
    </div>

    <!-- Main Content (Map Section) -->
    <div class="flex-1 bg-white overflow-y-auto">
        <div class="min-h-screen flex flex-col gap-6">
            <div id="map"></div>

            <script>
                // Replace with your Mapbox token
                mapboxgl.accessToken = 'pk.eyJ1IjoiNTVoYXJyeSIsImEiOiJjbTV2M2U5emIwMmVnMmlzOTEzYm9zcG05In0.IFJCmaZz8bMJevo4eWtgFw';

                // Initialize the map
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    zoom: 10,
                    center: [9.360179504390425, 48.65777153727524] // Default center (matches initial fake GPS position)
                });

                // Add zoom and rotation controls
                map.addControl(new mapboxgl.NavigationControl());

                // Marker to represent the vehicle
                const vehicleMarker = new mapboxgl.Marker()
                    .setLngLat([9.360179504390425, 48.65777153727524]) // Initial position
                    .addTo(map);

                // Connect to the WebSocket server
                const websocketUrl = "ws://localhost:5678"; // WebSocket server address
                const socket = new WebSocket(websocketUrl);

                // Handle WebSocket connection open
                socket.onopen = () => {
                    console.log("Connected to WebSocket server");
                };

                // Handle incoming WebSocket messages
                socket.onmessage = (event) => {
                    try {
                        // Parse the JSON data
                        const data = JSON.parse(event.data);

                        // Extract the position (latitude and longitude)
                        const [lat, lng] = data.position;
                        console.log("Received Position:", { lat, lng });

                        // Update the marker's position
                        vehicleMarker.setLngLat([lng, lat]);

                        // Optionally center the map on the new position
                        map.flyTo({
                            center: [lng, lat],
                            speed: 0.5
                        });
                    } catch (err) {
                        console.error("Error parsing WebSocket data:", err);
                    }
                };

                // Handle WebSocket connection close
                socket.onclose = () => {
                    console.log("WebSocket connection closed");
                };

                // Handle WebSocket errors
                socket.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };
            </script>
        </div>
    </div>
    <script th:src="@{/js/populateTrackUnits.js}">
    </script>
</div>
</body>
</html>
